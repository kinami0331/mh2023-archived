var Imported=Imported||{};Imported.YEP_RegionEvents=true;var Yanfly=Yanfly||{};Yanfly.RCE=Yanfly.RCE||{};Yanfly.Parameters=PluginManager.parameters("YEP_RegionEvents");Yanfly.Param=Yanfly.Param||{};Yanfly.RCE.RegionEvents={};for(Yanfly.i=1;Yanfly.i<=255;++Yanfly.i){Yanfly.line="Number(Yanfly.Parameters['Region "+Yanfly.i+"'] || 0)";Yanfly.RCE.RegionEvents[Yanfly.i]=eval(Yanfly.line)}DataManager.processRECNotetags=function(){if(!$dataMap)return;if(!$dataMap.note)return;var notedata=$dataMap.note.split(/[\r\n]+/);$dataMap.regionCommonEvents={};for(var i=0;i<notedata.length;i++){var line=notedata[i];if(line.match(/<(?:REGION)[ ](\d+)[ ](?:EVENT):[ ](\d+)>/i)){$dataMap.regionCommonEvents[parseInt(RegExp.$1)]=parseInt(RegExp.$2)}}};Yanfly.RCE.Game_Map_setup=Game_Map.prototype.setup;Game_Map.prototype.setup=function(mapId){if($dataMap)DataManager.processRECNotetags();Yanfly.RCE.Game_Map_setup.call(this,mapId)};Game_Map.prototype.isRegionEvent=function(mx,my){return this.isValid(mx,my)&&this.regionEventTag(mx,my)};Game_Map.prototype.getUniqueRegionCommonEvent=function(regionId){if($dataMap.regionCommonEvents===undefined){DataManager.processRECNotetags()}if($dataMap.regionCommonEvents&&$dataMap.regionCommonEvents[regionId]){return $dataMap.regionCommonEvents[regionId]}return 0};Game_Map.prototype.regionEventTag=function(mx,my){if(this.regionId(mx,my)<=0)return false;var regionId=this.regionId(mx,my);if(this.getUniqueRegionCommonEvent(regionId)>0)return true;return Yanfly.RCE.RegionEvents[regionId]>0};Game_Map.prototype.moveAfterCommonEvent=function(){var interpreter=$gameMap._interpreter;if(!interpreter._list)return false;if(interpreter.eventId()>0)return false;var list=interpreter._list;if($gameTemp.destinationX()===$gamePlayer.x&&$gameTemp.destinationY()===$gamePlayer.y){$gameTemp.clearDestination()}for(var i=0;i<list.length;++i){var code=list[i].code;if([201,205,230,232,261,301].contains(code))return false}return true};Yanfly.RCE.Game_Player_checkEventTriggerHere=Game_Player.prototype.checkEventTriggerHere;Game_Player.prototype.checkEventTriggerHere=function(triggers){if(!this.canStartLocalEvents())return;this.processRegionEvent();Yanfly.RCE.Game_Player_checkEventTriggerHere.call(this,triggers)};Game_Player.prototype.processRegionEvent=function(){if(!$gameMap.isRegionEvent(this.x,this.y))return;if(Input.isTriggered("ok"))return;var regionId=$gameMap.regionId(this.x,this.y);if($gameMap.getUniqueRegionCommonEvent(regionId)>0){var commonEventId=$gameMap.getUniqueRegionCommonEvent(regionId)}else{var commonEventId=Yanfly.RCE.RegionEvents[regionId]}$gameTemp.reserveCommonEvent(commonEventId)};Yanfly.RCE.Game_Player_canMove=Game_Player.prototype.canMove;Game_Player.prototype.canMove=function(){if($gameMessage.isBusy()){return false}if(this.isMoveRouteForcing()||this.areFollowersGathering()){return false}if(this._vehicleGettingOn||this._vehicleGettingOff){return false}if(this.isInVehicle()&&!this.vehicle().canMove()){return false}if($gameMap.isEventRunning()&&$gameMap.moveAfterCommonEvent()){return true}return Yanfly.RCE.Game_Player_canMove.call(this)};