(function(){var getCommandName=function(command){return(command||"").toUpperCase()};var getArgNumber=function(arg,min,max){if(arguments.length<2)min=-Infinity;if(arguments.length<3)max=Infinity;return(parseInt(convertEscapeCharacters(arg.toString()),10)||0).clamp(min,max)};var getArgString=function(arg,upperFlg){arg=convertEscapeCharacters(arg);return upperFlg?arg.toUpperCase():arg};var connectArgs=function(args,startIndex,endIndex){if(arguments.length<2)startIndex=0;if(arguments.length<3)endIndex=args.length;var text="";for(var i=startIndex;i<endIndex;i++){text+=args[i];if(i<endIndex-1)text+=" "}return text};var convertEscapeCharacters=function(text){if(text==null)text="";var window=SceneManager.getHiddenWindow();return window?window.convertEscapeCharacters(text):text};SceneManager.getHiddenWindow=function(){return this._scene._hiddenWindow};var _Game_Interpreter_pluginCommand=Game_Interpreter.prototype.pluginCommand;Game_Interpreter.prototype.pluginCommand=function(command,args){_Game_Interpreter_pluginCommand.apply(this,arguments);try{this.pluginCommandDTextPicture(command,args)}catch(e){if($gameTemp.isPlaytest()&&Utils.isNwjs()){var window=require("nw.gui").Window.get();if(!window.isDevToolsOpen()){var devTool=window.showDevTools();devTool.moveTo(0,0);devTool.resizeTo(Graphics.width,Graphics.height);window.focus()}}console.log("プラグインコマンドの実行中にエラーが発生しました。");console.log("- コマンド名 　: "+command);console.log("- コマンド引数 : "+args);console.log("- エラー原因   : "+e.toString())}};Game_Interpreter.textAlignMapper={LEFT:0,CENTER:1,RIGHT:2,"左":0,"中央":1,"右":2};Game_Interpreter.prototype.pluginCommandDTextPicture=function(command,args){switch(getCommandName(command)){case"D_TEXT":if(isNaN(args[args.length-1]))args.push($gameScreen.dTextSize||28);var fontSize=getArgNumber(args.pop());$gameScreen.setDTextPicture(getArgString(connectArgs(args),false),fontSize);break;case"D_TEXT_SETTING":switch(getCommandName(args[0])){case"ALIGN":$gameScreen.dTextAlign=isNaN(args[1])?Game_Interpreter.textAlignMapper[getArgString(args[1],true)]:getArgNumber(args[1],0,2);break;case"BG_COLOR":$gameScreen.dTextBackColor=getArgString(connectArgs(args,1));break;case"FONT":$gameScreen.setFont(getArgString(args[1]));break}break}};var _Game_Screen_clear=Game_Screen.prototype.clear;Game_Screen.prototype.clear=function(){_Game_Screen_clear.call(this);this.clearDTextPicture()};Game_Screen.prototype.clearDTextPicture=function(){this.dTextValue=null;this.dTextSize=0;this.dTextAlign=0;this.dTextBackColor=null;this.dTextFont=null};Game_Screen.prototype.setDTextPicture=function(value,size){if(!this.dTextValue)this.dTextValue=[];this.dTextValue.push(value);this.dTextSize=size};Game_Screen.prototype.getDTextPictureInfo=function(){return{value:this.dTextValue,size:this.dTextSize,align:this.dTextAlign,color:this.dTextBackColor,font:this.dTextFont}};Game_Screen.prototype.isSettingDText=function(){return!!this.dTextValue};Game_Screen.prototype.setFont=function(name){if(Graphics.isFontLoaded(name)){this.dTextFont=name}};var _Game_Picture_initBasic=Game_Picture.prototype.initBasic;Game_Picture.prototype.initBasic=function(){_Game_Picture_initBasic.call(this);this.dTextValue=null;this.dTextInfo=null};var _Game_Picture_show=Game_Picture.prototype.show;Game_Picture.prototype.show=function(name,origin,x,y,scaleX,scaleY,opacity,blendMode){if($gameScreen.isSettingDText()){arguments[0]=Date.now().toString();var textValue="";this.dTextInfo=$gameScreen.getDTextPictureInfo();this.dTextInfo.value.forEach(function(text){textValue+=text+"\n"}.bind(this));this.dTextInfo.value=textValue}else{this.dTextInfo=null}$gameScreen.clearDTextPicture();_Game_Picture_show.apply(this,arguments)};var _Window_Base_convertEscapeCharacters=Window_Base.prototype.convertEscapeCharacters;Window_Base.prototype.convertEscapeCharacters=function(text){text=_Window_Base_convertEscapeCharacters.call(this,text);text=text.replace(/\x1bV\[(\d+)\,(\d+)\]/gi,function(){return $gameVariables.value(parseInt(arguments[1])).padZero(arguments[2])}.bind(this));text=text.replace(/\x1bITEM\[(\d+)\]/gi,function(){var item=$dataItems[getArgNumber(arguments[1],1,$dataItems.length)];return item?"i["+item.iconIndex+"]"+item.name:""}.bind(this));text=text.replace(/\x1bWEAPON\[(\d+)\]/gi,function(){var item=$dataWeapons[getArgNumber(arguments[1],1,$dataWeapons.length)];return item?"i["+item.iconIndex+"]"+item.name:""}.bind(this));text=text.replace(/\x1bARMOR\[(\d+)\]/gi,function(){var item=$dataArmors[getArgNumber(arguments[1],1,$dataArmors.length)];return item?"i["+item.iconIndex+"]"+item.name:""}.bind(this));text=text.replace(/\x1bSKILL\[(\d+)\]/gi,function(){var item=$dataSkills[getArgNumber(arguments[1],1,$dataSkills.length)];return item?"i["+item.iconIndex+"]"+item.name:""}.bind(this));text=text.replace(/\x1bSTATE\[(\d+)\]/gi,function(){var item=$dataStates[getArgNumber(arguments[1],1,$dataStates.length)];return item?"i["+item.iconIndex+"]"+item.name:""}.bind(this));return text};var _Sprite_Picture_loadBitmap=Sprite_Picture.prototype.loadBitmap;Sprite_Picture.prototype.loadBitmap=function(){this.dTextInfo=this.picture().dTextInfo;if(this.dTextInfo){this.makeDynamicBitmap()}else{_Sprite_Picture_loadBitmap.call(this)}};Sprite_Picture.prototype.makeDynamicBitmap=function(){this.textWidths=[];this.hiddenWindow=SceneManager.getHiddenWindow();if(this.dTextInfo.font)this.hiddenWindow.contents.fontFace=this.dTextInfo.font;if(this.dTextInfo.size>0)this.hiddenWindow.contents.fontSize=this.dTextInfo.size;var bitmapVirtual=new Bitmap_Virtual;this._processText(bitmapVirtual);this.bitmap=new Bitmap(bitmapVirtual.width,bitmapVirtual.height);if(this.dTextInfo.font)this.bitmap.fontFace=this.dTextInfo.font;if(this.dTextInfo.color)this.bitmap.fillAll(this.dTextInfo.color);this._processText(this.bitmap);this.hiddenWindow=null};Sprite_Picture.prototype._processText=function(bitmap){var textState={index:0,x:0,y:0,text:this.dTextInfo.value,left:0,line:-1,height:0};this._processNewLine(textState,bitmap);textState.height=this.hiddenWindow.calcTextHeight(textState,false);textState.index=0;while(textState.text[textState.index]){this._processCharacter(textState,bitmap)}};Sprite_Picture.prototype._processCharacter=function(textState,bitmap){if(textState.text[textState.index]===""){var code=this.hiddenWindow.obtainEscapeCode(textState);switch(code){case"C":bitmap.textColor=this.hiddenWindow.textColor(this.hiddenWindow.obtainEscapeParam(textState));break;case"I":this._processDrawIcon(this.hiddenWindow.obtainEscapeParam(textState),textState,bitmap);break;case"{":this.hiddenWindow.makeFontBigger();break;case"}":this.hiddenWindow.makeFontSmaller();break;case"F":switch(this.hiddenWindow.obtainEscapeParam(textState)){case"I":bitmap.fontItalic=true;break;case"/":case"N":bitmap.fontItalic=false;break}break}}else if(textState.text[textState.index]==="\n"){this._processNewLine(textState,bitmap)}else{var c=textState.text[textState.index++];var w=this.hiddenWindow.textWidth(c);bitmap.fontSize=this.hiddenWindow.contents.fontSize;bitmap.drawText(c,textState.x,textState.y,w*2,textState.height,"left");textState.x+=w}};Sprite_Picture.prototype._processNewLine=function(textState,bitmap){if(bitmap instanceof Bitmap_Virtual)this.textWidths[textState.line]=textState.x;this.hiddenWindow.processNewLine(textState);textState.line++;if(bitmap instanceof Bitmap)textState.x=(bitmap.width-this.textWidths[textState.line])/2*this.dTextInfo.align};Sprite_Picture.prototype._processDrawIcon=function(iconIndex,textState,bitmap){var iconBitmap=ImageManager.loadSystem("IconSet");var pw=Window_Base._iconWidth;var ph=Window_Base._iconHeight;var sx=iconIndex%16*pw;var sy=Math.floor(iconIndex/16)*ph;bitmap.blt(iconBitmap,sx,sy,pw,ph,textState.x+2,textState.y+(textState.height-ph)/2);textState.x+=Window_Base._iconWidth+4};var _Scene_Map_createDisplayObjects=Scene_Map.prototype.createDisplayObjects;Scene_Map.prototype.createDisplayObjects=function(){this._hiddenWindow=new Window_Base(1,1,1,1);this._hiddenWindow.hide();this._hiddenWindow.deactivate();_Scene_Map_createDisplayObjects.call(this);this.addChild(this._hiddenWindow)};var _Scene_Battle_createDisplayObjects=Scene_Battle.prototype.createDisplayObjects;Scene_Battle.prototype.createDisplayObjects=function(){this._hiddenWindow=new Window_Base(1,1,1,1);this._hiddenWindow.hide();this._hiddenWindow.deactivate();_Scene_Battle_createDisplayObjects.call(this);this.addChild(this._hiddenWindow)};function Bitmap_Virtual(){this.initialize.apply(this,arguments)}Bitmap_Virtual.prototype.initialize=function(){this.window=SceneManager.getHiddenWindow();this.width=0;this.height=0};Bitmap_Virtual.prototype.drawText=function(text,x,y,maxWidth,lineHeight,align){this.width=Math.max(x+this.window.textWidth(text),this.width);this.height=Math.max(y+this.window.contents.fontSize+8,this.height)};Bitmap_Virtual.prototype.blt=function(source,sx,sy,sw,sh,dx,dy,dw,dh){this.width=Math.max(dx+(dw||sw),this.width);this.height=Math.max(dy+(dy||sy),this.height)}})();