var Imported=Imported||{};Imported.YEP_MapSelectSkill=true;var Yanfly=Yanfly||{};Yanfly.MSS=Yanfly.MSS||{};Yanfly.MSS.version=1.02;Yanfly.Parameters=PluginManager.parameters("YEP_MapSelectSkill");Yanfly.Param=Yanfly.Param||{};Yanfly.Param.MSSCol=Number(Yanfly.Parameters["Default Columns"]);Yanfly.Param.MSSRow=Number(Yanfly.Parameters["Default Rows"]);Yanfly.Param.MSSPosX=String(Yanfly.Parameters["Default X Position"]);Yanfly.Param.MSSPosY=String(Yanfly.Parameters["Default Y Position"]);Yanfly.Param.MSSWidth=Number(Yanfly.Parameters["Default Width"]);Yanfly.Param.MSSEnable=eval(String(Yanfly.Parameters["Default Enable"]));Yanfly.Param.MSSCost=eval(String(Yanfly.Parameters["Default Cost"]));Yanfly.Param.DefaultEvent=Number(Yanfly.Parameters["Default Event"]);Yanfly.MSS.Game_System_initialize=Game_System.prototype.initialize;Game_System.prototype.initialize=function(){Yanfly.MSS.Game_System_initialize.call(this);this.initMapSelectSkill()};Game_System.prototype.initMapSelectSkill=function(){this._mapSelectSkillWindowColumns=Yanfly.Param.MSSCol;this._mapSelectSkillWindowRows=Yanfly.Param.MSSRow;this._mapSelectSkillWindowPosX=Yanfly.Param.MSSPosX;this._mapSelectSkillWindowPosY=Yanfly.Param.MSSPosY;this._mapSelectSkillWindowWidth=Yanfly.Param.MSSWidth;this._mapSelectSkillWindowEnable=Yanfly.Param.MSSEnable;this._mapSelectSkillWindowCosts=Yanfly.Param.MSSCost};Game_System.prototype.getMapSelectSkillColumns=function(){if(this._mapSelectSkillWindowColumns===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowColumns};Game_System.prototype.setMapSelectSkillColumns=function(value){if(this._mapSelectSkillWindowColumns===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowColumns=value};Game_System.prototype.getMapSelectSkillRows=function(){if(this._mapSelectSkillWindowRows===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowRows};Game_System.prototype.setMapSelectSkillRows=function(value){if(this._mapSelectSkillWindowRows===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowRows=value};Game_System.prototype.getMapSelectSkillPosX=function(){if(this._mapSelectSkillWindowPosX===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowPosX};Game_System.prototype.setMapSelectSkillPosX=function(value){if(this._mapSelectSkillWindowPosX===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowPosX=value};Game_System.prototype.getMapSelectSkillPosY=function(){if(this._mapSelectSkillWindowPosY===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowPosY};Game_System.prototype.setMapSelectSkillPosY=function(value){if(this._mapSelectSkillWindowPosY===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowPosY=value};Game_System.prototype.getMapSelectSkillWidth=function(){if(this._mapSelectSkillWindowWidth===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowWidth};Game_System.prototype.setMapSelectSkillWidth=function(value){if(this._mapSelectSkillWindowWidth===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowWidth=value};Game_System.prototype.getMapSelectSkillEnable=function(){if(this._mapSelectSkillWindowEnable===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowEnable};Game_System.prototype.setMapSelectSkillEnable=function(value){if(this._mapSelectSkillWindowEnable===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowEnable=value};Game_System.prototype.getMapSelectSkillCosts=function(){if(this._mapSelectSkillWindowCosts===undefined){this.initMapSelectSkill()}return this._mapSelectSkillWindowCosts};Game_System.prototype.setMapSelectSkillCosts=function(value){if(this._mapSelectSkillWindowCosts===undefined){this.initMapSelectSkill()}this._mapSelectSkillWindowCosts=value};function Window_MapSelectSkillCommand(){this.initialize.apply(this,arguments)}Window_MapSelectSkillCommand.prototype=Object.create(Window_Command.prototype);Window_MapSelectSkillCommand.prototype.constructor=Window_MapSelectSkillCommand;Window_MapSelectSkillCommand.prototype.initialize=function(){Window_Command.prototype.initialize.call(this,0,0);this.hide()};Window_MapSelectSkillCommand.prototype.windowWidth=function(){return 148};Window_MapSelectSkillCommand.prototype.makeCommandList=function(){this.addCommand("选择","use");this.addCommand("返回","cancel")};Window_MapSelectSkillCommand.prototype.updatePos=function(wx,wy,rect){var sx=wx+rect.x+rect.width-4;var sy=wy+rect.y+rect.height-4;if(sx+this.width>Graphics.boxWidth)sx=Graphics.boxWidth-this.width;if(sy+this.height>Graphics.boxHeight)sy=Graphics.boxHeight-this.height;this.x=sx;this.y=sy;this.show();this.activate();this.refresh()};function Window_QuickTap(){this.initialize.apply(this,arguments)}Window_QuickTap.prototype=Object.create(Window_Base.prototype);Window_QuickTap.prototype.constructor=Window_QuickTap;Window_QuickTap.prototype.initialize=function(x,y,width,text){var height=this.fittingHeight(1);Window_Base.prototype.initialize.call(this,x,y,width,height);this._handlers={};this._text="";this._tap=false;this.setText(text);this.hide();this.close();this.deactivate()};Window_QuickTap.prototype.standardPadding=function(){return 12};Window_QuickTap.prototype.setText=function(text){if(this._text!==text){this._text=text;this.refresh()}};Window_QuickTap.prototype.clear=function(){this.setText("")};Window_QuickTap.prototype.refresh=function(){this.contents.clear();this.drawText(this._text,2,0,this.contentsWidth()-4,"center")};Window_QuickTap.prototype.update=function(){Window_Base.prototype.update.call(this);this.isTap()};Window_QuickTap.prototype.setHandler=function(symbol,method){this._handlers[symbol]=method};Window_QuickTap.prototype.isHandled=function(symbol){return!!this._handlers[symbol]};Window_QuickTap.prototype.callHandler=function(symbol){if(this.isHandled(symbol)){this._handlers[symbol]()}};Window_QuickTap.prototype.resetCursorRect=function(){this.setCursorRect(0,0,0,0)};Window_QuickTap.prototype.setWholeCursorRect=function(){this.setCursorRect(0,0,this.contentsWidth,this.contentsHeight)};Window_QuickTap.prototype.isTap=function(){if(this.isOpen()){if(TouchInput.isTriggered()){var x=this.canvasToLocalX(TouchInput.x);var y=this.canvasToLocalY(TouchInput.y);if(x>=0&&y>=0&&x<this.width&&y<this.height){this._tap=!this._tap;this.callHandler("tap")}}}};Yanfly.MSS.Game_Interpreter_pluginCommand=Game_Interpreter.prototype.pluginCommand;Game_Interpreter.prototype.pluginCommand=function(command,args){Yanfly.MSS.Game_Interpreter_pluginCommand.call(this,command,args);if(command==="MapSelectSkill"){if(SceneManager._scene instanceof Scene_Map){var varId=parseInt(args[0]);var actorId=parseInt(args[1]);var stypeId=parseInt(args[2]||0);SceneManager._scene.setupMapSelectSkill(varId,actorId,stypeId);this.wait(10)}}else if(command==="MapSelectSkillColumns"){var value=parseInt(args[0]);$gameSystem.setMapSelectSkillColumns(value)}else if(command==="MapSelectSkillRows"){var value=parseInt(args[0]);$gameSystem.setMapSelectSkillRows(value)}else if(command==="MapSelectSkillWidth"){var value=parseInt(args[0]);$gameSystem.setMapSelectSkillWidth(value)}else if(command==="MapSelectSkillX"){var value=String(args[0]).toLowerCase();$gameSystem.setMapSelectSkillPosX(value)}else if(command==="MapSelectSkillY"){var value=String(args[0]).toLowerCase();$gameSystem.setMapSelectSkillPosY(value)}else if(command==="EnableAllMapSelectSkills"){$gameSystem.setMapSelectSkillEnable(true)}else if(command==="NormalAllMapSelectSkills"){$gameSystem.setMapSelectSkillEnable(false)}else if(command==="ShowMapSelectSkillCost"){$gameSystem.setMapSelectSkillCosts(true)}else if(command==="HideMapSelectSkillCost"){$gameSystem.setMapSelectSkillCosts(false)}};function Window_MapSelectSkill(){this.initialize.apply(this,arguments)}Window_MapSelectSkill.prototype=Object.create(Window_SkillList.prototype);Window_MapSelectSkill.prototype.constructor=Window_MapSelectSkill;Window_MapSelectSkill.prototype.initialize=function(){var width=this.windowWidth();var height=this.windowHeight();Window_Selectable.prototype.initialize.call(this,0,0,width,height);this.openness=0};Window_MapSelectSkill.prototype.windowWidth=function(){return this._windowWidth||Graphics.boxWidth};Window_MapSelectSkill.prototype.windowHeight=function(){return this._windowHeight||this.fittingHeight(4)};Window_MapSelectSkill.prototype.setup=function(varId,actorId,stypeId){if(!varId)return;if(!actorId)return;this.updateWindowSettings();this._varId=varId;this.setActor($gameActors.actor(actorId));this.setStypeId(stypeId);this.refresh();this.activate();this.open();this.select(0)};Window_MapSelectSkill.prototype.includes=function(item){if(!this._stypeId)return item;return item&&item.stypeId===this._stypeId};Window_MapSelectSkill.prototype.maxCols=function(){return $gameSystem.getMapSelectSkillColumns()||1};Window_MapSelectSkill.prototype.updateWindowSettings=function(){this.width=$gameSystem.getMapSelectSkillWidth()||Graphics.boxWidth;var col=$gameSystem.getMapSelectSkillRows()||4;this.height=this.fittingHeight(col);if($gameSystem.getMapSelectSkillPosX()==="left"){this.x=0}else if($gameSystem.getMapSelectSkillPosX()==="center"){this.x=Math.floor((Graphics.boxWidth-this.width)/2)}else{this.x=Graphics.boxWidth-this.width}if($gameSystem.getMapSelectSkillPosY()==="top"){this.y=0}else if($gameSystem.getMapSelectSkillPosY()==="middle"){this.y=Math.floor((Graphics.boxHeight-this.height)/2)}else{this.y=Graphics.boxHeight-this.height}};Window_MapSelectSkill.prototype.isEnabled=function(item){if($gameSystem.getMapSelectSkillEnable())return true;return Window_SkillList.prototype.isEnabled.call(this,item)};Window_MapSelectSkill.prototype.drawSkillCost=function(skill,x,y,width){if($gameSystem.getMapSelectSkillCosts()){var width=Window_SkillList.prototype.drawSkillCost.call(this,skill,x,y,width)}};Yanfly.MSS.Scene_Map_updateMain=Scene_Map.prototype.updateMain;Scene_Map.prototype.updateMain=function(){if(this._eventActive){this._interpreter.update();if(!this._interpreter.isRunning())this.eventTerminate()}Yanfly.MSS.Scene_Map_updateMain.call(this)};Yanfly.MSS.Scene_Map_createAllWindows=Scene_Map.prototype.createAllWindows;Scene_Map.prototype.createAllWindows=function(){Yanfly.MSS.Scene_Map_createAllWindows.call(this);this.createMapSelectSkillWindow();this.createCloseTap();this.createHelpWindow();this.createSkillCommandWindow();this._interpreter=new Game_Interpreter(this)};Scene_Map.prototype.createMapSelectSkillWindow=function(){this._mapSelectSkillWindow=new Window_MapSelectSkill;this._mapSelectSkillWindow.setHandler("ok",this.onMapSelectSkillOk.bind(this));this._mapSelectSkillWindow.setHandler("cancel",this.onMapSelectSkillCancel.bind(this));this.addChild(this._mapSelectSkillWindow)};Scene_Map.prototype.createCloseTap=function(){this._closeTap=new Window_QuickTap(0,0,126,"返回");this._closeTap.setHandler("tap",this.onMapSelectSkillCancel.bind(this));this.addChild(this._closeTap)};Scene_Map.prototype.createSkillCommandWindow=function(){this._skillCommand=new Window_MapSelectSkillCommand;this._skillCommand.setHandler("use",this.onSkillUse.bind(this));this._skillCommand.setHandler("cancel",this.onSkillCommandCancel.bind(this));this.addChild(this._skillCommand);this._skillCommand.deactivate()};Scene_Map.prototype.createHelpWindow=function(){this._helpWindow=new Window_Help;this._mapSelectSkillWindow.setHelpWindow(this._helpWindow);this.addChild(this._helpWindow)};Scene_Map.prototype.setupMapSelectSkill=function(varId,actorId,stypeId){this._mapSelectSkillWindow.setup(varId,actorId,stypeId);this._closeTap.x=this._mapSelectSkillWindow.x+this._mapSelectSkillWindow.width-this._closeTap.width;this._closeTap.y=this._mapSelectSkillWindow.y+this._mapSelectSkillWindow.height;this._closeTap.show();this._closeTap.open();this._closeTap.activate();this._active=false};Scene_Map.prototype.onMapSelectSkillOk=function(){if(this._mapSelectSkillWindow.item()){this._skillCommand.updatePos(this._mapSelectSkillWindow.x,this._mapSelectSkillWindow.y,this._mapSelectSkillWindow.itemRect(this._mapSelectSkillWindow.index()))}};Scene_Map.prototype.onSkillUse=function(){SoundManager.playUseSkill();var skill=this._mapSelectSkillWindow.item();var varId=this._mapSelectSkillWindow._varId;if(Imported.YEP_SelfSwVar)$gameTemp.clearSelfSwVarEvBridge();if(!skill){$gameVariables.setValue(varId,0)}else{$gameVariables.setValue(varId,skill.id)}if(Imported.YEP_SelfSwVar)$gameTemp.clearSelfSwVarEvent();var event=skill.meta.event||Yanfly.Param.DefaultEvent;if(event>0){this._closeTap.close();$gameTemp.reserveCommonEvent(event);this._eventActive=true;this._interpreter.setupReservedCommonEvent()}else this._mapSelectSkillWindow.activate();this._skillCommand.hide();this._mapSelectSkillWindow.close();this._helpWindow.hide();this._skillCommand.hide();this._closeTap.close();this._active=true};Scene_Map.prototype.eventTerminate=function(){this._eventActive=false;this._mapSelectSkillWindow.activate();this._closeTap.open()};Scene_Map.prototype.onSkillCommandCancel=function(){this._skillCommand.hide();this._mapSelectSkillWindow.activate()};Scene_Map.prototype.onMapSelectSkillCancel=function(){SoundManager.playCancel();this._mapSelectSkillWindow.close();this._helpWindow.hide();this._skillCommand.hide();this._closeTap.close();this._active=true};