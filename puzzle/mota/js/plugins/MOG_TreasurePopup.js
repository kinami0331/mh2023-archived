var Imported=Imported||{};Imported.MOG_TreasurePopup=true;var Moghunter=Moghunter||{};Moghunter.parameters=PluginManager.parameters("MOG_TreasurePopup");Moghunter.trpopup_X=Number(Moghunter.parameters["X - Axis"]||0);Moghunter.trpopup_Y=Number(Moghunter.parameters["Y - Axis"]||0);Moghunter.trpopup_GoldVisible=String(Moghunter.parameters["Gold Popup"]||"true");Moghunter.trpopup_Random=String(Moghunter.parameters["Random Movement"]||"false");Moghunter.trpopup_SX=Number(Moghunter.parameters["X Speed"]||0);Moghunter.trpopup_SY=Number(Moghunter.parameters["Y Speed"]||1);Moghunter.trpopup_IconScale=Number(Moghunter.parameters["Icon Scale"]||.6);Moghunter.trpopup_ItemSpace=Number(Moghunter.parameters["Treasure Space Y-Axis"]||20);Moghunter.trpopup_waitD=Number(Moghunter.parameters["Duration"]||15);Moghunter.trpopup_Zoom=String(Moghunter.parameters["Zoom Effect"]||"false");Moghunter.trpopup_fadeSpeed=Number(Moghunter.parameters["Fade Speed"]||5);Moghunter.trpopup_goldIconIndex=Number(Moghunter.parameters["Gold Icon Index"]||163);Moghunter.trpopup_fontSize=Number(Moghunter.parameters["Font Size"]||16);var _mog_treapopup_Gsys_initialize=Game_System.prototype.initialize;Game_System.prototype.initialize=function(){_mog_treapopup_Gsys_initialize.call(this);this._trspupData=[];this._trspupSprData=null;this._trspupVisible=true;this._trspupMapID=0};var _mog_treapopup_scMap_terminate=Scene_Map.prototype.terminate;Scene_Map.prototype.terminate=function(){_mog_treapopup_scMap_terminate.call(this);if(this._spriteset){this._spriteset.recordTreasureData()}};var _mog_treaPopUP_gint_command125=Game_Interpreter.prototype.command125;Game_Interpreter.prototype.command125=function(){_mog_treaPopUP_gint_command125.call(this);if(Moghunter.trpopup_GoldVisible==="true"){this.checkTreasurePopup(3)}return true};var _mog_treaPopUP_gint_command126=Game_Interpreter.prototype.command126;Game_Interpreter.prototype.command126=function(){_mog_treaPopUP_gint_command126.call(this);this.checkTreasurePopup(0);return true};var _mog_treaPopUP_gint_command127=Game_Interpreter.prototype.command127;Game_Interpreter.prototype.command127=function(){_mog_treaPopUP_gint_command127.call(this);this.checkTreasurePopup(1);return true};var _mog_treaPopUP_gint_command128=Game_Interpreter.prototype.command128;Game_Interpreter.prototype.command128=function(){_mog_treaPopUP_gint_command128.call(this);this.checkTreasurePopup(2);return true};Game_Interpreter.prototype.checkTreasurePopup=function(type){if($gameSystem._trspupVisible){if(type>2){var amount=this.operateValue(this._params[0],this._params[1],this._params[2])}else{var amount=this.operateValue(this._params[1],this._params[2],this._params[3])}if(amount>0&&SceneManager._scene.constructor.name==="Scene_Map"){for(i=0;i<$gameMap.events().length;i++){var eve=$gameMap.events()[i];if(eve&&this._eventId===eve._eventId){var x=eve.screenX();var y=eve.screenY();$gameSystem._trspupData.push([this.trPopupType(type),amount,x,y])}}}}};Game_Interpreter.prototype.trPopupType=function(type){if(type===0){return $dataItems[this._params[0]]}if(type===1){return $dataWeapons[this._params[0]]}if(type===2){return $dataArmors[this._params[0]]}return null};var _alias_mog_theaPopUP_pluginCommand=Game_Interpreter.prototype.pluginCommand;Game_Interpreter.prototype.pluginCommand=function(command,args){_alias_mog_theaPopUP_pluginCommand.call(this,command,args);if(command==="show_treasure_popup"){$gameSystem._trspupVisible=true}if(command==="hide_treasure_popup"){$gameSystem._trspupVisible=false}return true};var _mog_treapopup_sprmap_createUpperLayer=Spriteset_Map.prototype.createUpperLayer;Spriteset_Map.prototype.createUpperLayer=function(){_mog_treapopup_sprmap_createUpperLayer.call(this);this.createTreasureField();if($gameSystem._trspupSprData&&$gameSystem._trspupMapID===$gameMap._mapId){this.loadTreasureIcons()}else{$gameSystem._trspupData=[];$gameSystem._trspupSprData=null}$gameSystem._trspupMapID=$gameMap._mapId};Spriteset_Map.prototype.recordTreasureData=function(){if(!this._treasureIcons||this._treasureIcons.length===0){return}$gameSystem._trspupSprData=[];for(i=0;i<this._treasureIcons.length;i++){$gameSystem._trspupSprData[i]={};$gameSystem._trspupSprData[i]._item=this._treasureIcons[i]._item;$gameSystem._trspupSprData[i]._amount=this._treasureIcons[i]._amount;$gameSystem._trspupSprData[i].x=this._treasureIcons[i].x;$gameSystem._trspupSprData[i].y=this._treasureIcons[i].y;$gameSystem._trspupSprData[i].opacity=this._treasureIcons[i].opacity;$gameSystem._trspupSprData[i].scale=this._treasureIcons[i].scale.x;$gameSystem._trspupSprData[i]._sx=this._treasureIcons[i]._sx;$gameSystem._trspupSprData[i]._sy=this._treasureIcons[i]._sy;$gameSystem._trspupSprData[i]._cx=this._treasureIcons[i]._cx;$gameSystem._trspupSprData[i]._cy=this._treasureIcons[i]._cy;$gameSystem._trspupSprData[i]._wait=this._treasureIcons[i]._wait}};Spriteset_Map.prototype.createTreasureField=function(){this._treasureIcons=[];this._treasureField=new Sprite;this.addChild(this._treasureField)};var _mog_treapopup_sprmap_update=Spriteset_Map.prototype.update;Spriteset_Map.prototype.update=function(){_mog_treapopup_sprmap_update.call(this);if(this._treasureField){this.updateTreasureIcons()}};Spriteset_Map.prototype.loadTreasureIcons=function(){for(i=0;i<$gameSystem._trspupSprData.length;i++){this._treasureIcons.push(new TreasureIcons(null,$gameSystem._trspupSprData[i],i,$gameSystem._trspupSprData.length));this._treasureField.addChild(this._treasureIcons[i])}$gameSystem._trspupSprData=null};Spriteset_Map.prototype.refreshTreasureIcons=function(){for(i=0;i<$gameSystem._trspupData.length;i++){this._treasureIcons.push(new TreasureIcons($gameSystem._trspupData[i],null,i,$gameSystem._trspupData.length));this._treasureField.addChild(this._treasureIcons[this._treasureIcons.length-1])}$gameSystem._trspupData=[]};Spriteset_Map.prototype.needRefreshTreasureIcons=function(){if($gameSystem._trspupData.length>0){return true}return false};Spriteset_Map.prototype.updateTreasureIcons=function(){if(this.needRefreshTreasureIcons()){this.refreshTreasureIcons()}for(i=0;i<this._treasureIcons.length;i++){if(this._treasureIcons[i].opacity===0&&this._treasureIcons[i]._wait[1]<=0){this._treasureField.removeChild(this._treasureField[i]);this._treasureIcons.splice(i,1)}}};function TreasureIcons(){this.initialize.apply(this,arguments)}TreasureIcons.prototype=Object.create(Sprite.prototype);TreasureIcons.prototype.constructor=TreasureIcons;TreasureIcons.prototype.initialize=function(data,dataOld,fx,fmax){Sprite.prototype.initialize.call(this);this._fadeSpeed=Math.min(Math.max(Moghunter.trpopup_fadeSpeed,1),100);this._waitR=Math.min(Math.max(Moghunter.trpopup_waitD,1),999);this._zoomAn=String(Moghunter.trpopup_Zoom)==="true"?true:false;this._fx=fx;this._fmax=fmax*this.waitD();this.createName();this.createIcon();if(dataOld){this.setupOld(dataOld)}else{this.setupNew(data)}this.refreshIcon();this.refreshName();this.x=-this.screenX()+this._cx;this.y=-this.screenY()+this._cy};TreasureIcons.prototype.setupOld=function(data){this._item=data._item;this._amount=data._amount;this.x=data.x;this.y=data.y;this.scale.x=data.scale;this.scale.y=data.scale;this.opacity=data.opacity;this._sx=data._sx;this._sy=data._sy;this._cx=data._cx;this._cy=data._cy;this._wait=data._wait};TreasureIcons.prototype.waitD=function(){return this._waitR};TreasureIcons.prototype.setupNew=function(data){this._item=data[0];this._amount=data[1];var name=this._item?this._item.name+" x "+this._amount:this._amount;var wd=this._name.bitmap.measureTextWidth(name);this._cx=data[2]-(Window_Base._iconWidth+12+wd)/2+Moghunter.trpopup_X+this.screenX();this._cy=data[3]-Window_Base._iconHeight+Moghunter.trpopup_Y+this.screenY();this._cy-=this._fx*Moghunter.trpopup_ItemSpace;var iw=this._fx*this.waitD();var iw2=this.waitD()+(this._fmax-iw);this._wait=[15,iw2];this.opacity=0;if(String(Moghunter.trpopup_Random)==="true"){var d=Math.randomInt(2);var sx=Math.random()*this.sxi()+this.sxi();this._sx=d===0?sx:-sx;this._sy=-(Math.random()+this.syi())}else{this._sx=this.sxi();this._sy=-this.syi()}};TreasureIcons.prototype.sxi=function(){return Moghunter.trpopup_SX};TreasureIcons.prototype.syi=function(){return Moghunter.trpopup_SY};TreasureIcons.prototype.createIcon=function(){this._iconImg=ImageManager.loadSystem("IconSet");this._icon=new Sprite(this._iconImg);this._icon.scale.x=Math.min(Math.max(Moghunter.trpopup_IconScale,.1),3);this._icon.scale.y=this._icon.scale.x;this._icon.anchor.x=.5;this._icon.anchor.y=.5;this._icon.x=Window_Base._iconWidth/2;this._icon.y=Window_Base._iconHeight/2;this.addChild(this._icon)};TreasureIcons.prototype.refreshIcon=function(){var w=Window_Base._iconWidth;var h=Window_Base._iconHeight;var iconindex=this._item?this._item.iconIndex:Moghunter.trpopup_goldIconIndex;var sx=iconindex%16*w;var sy=Math.floor(iconindex/16)*h;this._icon.setFrame(sx,sy,w,h)};TreasureIcons.prototype.createName=function(){this._name=new Sprite(new Bitmap(150,32));this._name.x=Window_Base._iconWidth+4;this._name.bitmap.fontSize=Moghunter.trpopup_fontSize;this.addChild(this._name)};TreasureIcons.prototype.refreshName=function(){this._name.bitmap.clear();var name=this._item?this._item.name+" x "+this._amount:this._amount;this._name.bitmap.drawText(name,0,0,145,32)};TreasureIcons.prototype.screenX=function(){return $gameMap.displayX()*$gameMap.tileWidth()};TreasureIcons.prototype.screenY=function(){return $gameMap.displayY()*$gameMap.tileHeight()};TreasureIcons.prototype.updatePosition=function(){this.x=-this.screenX()+this._cx;this.y=-this.screenY()+this._cy};TreasureIcons.prototype.updateMovement=function(){this._cx+=this._sx;this._cy+=this._sy};TreasureIcons.prototype.updateOther=function(){this.opacity-=this._fadeSpeed;if(this._zoomAn){this.scale.x+=.01;this.scale.y=this.scale.x}};TreasureIcons.prototype.update=function(){Sprite.prototype.update.call(this);if(this._wait[0]>0){this._wait[0]--;this.opacity+=17;this.updatePosition();if(this._wait[1]<=0){this.opacity+=255;this._wait[0]=0}return}if(this._wait[1]>0){this._wait[1]--;this.updatePosition();return}this.updateMovement();this.updateOther();this.updatePosition()};